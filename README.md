# RenesandroTask


## Deploy

add config.py
```
ELEVEN_LABS_APIKEY = ""

FPS = 5

MAIN_FOLDER_ID = ""

HOST="0.0.0.0"

JWT_SECRET = ""
JWT_ALG = "HS256"
JWT_EXPIRE_MIN = 60
```

add client_secret.json
```
Скачати можна з Google cloud console->Credentials->тисніть потрібний oauth-> і кнопку завантажити
```

run
```
docker compose up
```


## Description

Create jwt token POST auth/token - {
"name",
"password"
}


Get status of media creation GET process_media/status/media_id -> 
```
{
    "status": "SUCCESS",
    "response": {"status": "queued|proccessing|error|done"}
}
```


Push to queue POST process_media -> 
```
{
    "status": "SUCCESS",
    "response": "Media successfully queued",
    "media_id": uuid
}
```


Струтура
```
Отримання реквесту -> Черга запуск, статус на обробляється-> Комбінаціх з відео = завантаження до стеку першого блоку і додавання до кожного елементу стеку відео з інших блоків (Кінцевий результат list[VideoFileClip] зі всіма комбінаціями)->Для кожного відео Рандомне аудіо ( якщо декілька блоків то з кожного) накладання звуку на відео з параметрами (В результаті list[VideoFileClip] відео з фоновим звуком) -> для кожного відео рандомний текст - текст в голос і на відео -> створення папки на гугл диску з назвою "{назва таски}-time.time"->збереження всіх файлів->змінення статусу на готов
```

## Problems
Спочатку думав проблем не буде. Але головною проблемою для мене стала обробка відео
Так як python має бібліотеку але вона професійна і зберігає кожний кадр - по часу виходе дуже довго
Спочатку спробував поміняти бібліотеку на ffmpeg але виявилось це проблематично - та потрібно було б міняти повністю логіку. Тому після розмови з 'підтримкою' вирішили зупинитись на тому що маєм - і покращувати можливість серверу (додавати cpu).


Наступною проблемою став google drive. Спочатку спробував зробити все максимально легко - використати service account але виявилось що функція запису файлів була заблокована гугл. Тому перешов на oauth.


Наразі боюсь що для обробки цих відео знадобиться сильний vps тому буде трішки дорого


## NEw for me

Ну по перше едітинг відео це те що я ніколи не робив - поки ще не максимально розібрався хоч і вже освоїв moviepy та хотів би ще погратись з ffmpeg


Redis я використовув много разово але тут вирішив спробувати ось нове redis в ролі черги - спершу думав про rabitmq але все ж таки вирішив зупинитись на редіс через те що дані можуть зберегтись і навть якщо программа полетить після запуску воно продовжить роботу.


Elevenlabs я ніколи не використовув хоча знав про них - в цілому апі в них не складне швидко розібрався


## Features that differntiate me

Ну по перше вирішив трішки запаритись і зробити все в асинхронці


Також додав jwt token для авторизації


Кожен ендпойнт максимально описан - хотів зробити апі максимально юзер френдлі


Також про чергу спочатку думав використовувати звичайну json-ку для збередення черги так як вже робив таке але вирішив трішки помудрити та додати редіс
PS: вийшло непогано думаю далі буду використовувати редіс для такх випадків


Спробувати зробити логи максимально інформативними та так що не бло все дуже масивно - сподіваюсь вийшло)))


Хотів би ще додати собі плюсик за струтуру проекту
```
└── RenesandroTask/
    ├── Dockerfile
    ├── compose.yaml
    ├── google_drive.py
    ├── main.py - очновний файл який запускається
    ├── media/ - весь еод який звязаний з обробкою медііа
    │   ├── audio.py
    │   ├── text.py
    │   └── video.py
    ├── media_looper.py - це черга
    ├── redis_config.py - конфіг для редісу
    ├── requirements.txt
    ├── routers/ - всі блоки ендпойнтів
    │   ├── auth.py
    │   └── process_media.py
    └── web/ - зручно працювати з апі через створену струтуру
        ├── get.py
        └── post.py
```


Також хотів би додати про логування зробив логування звичайне та збереження в файли 5 бекапів по 5мб


А ще побачив таку штуку що не була скаана в тз якщо будуть завантажені декілька блоків аудіо - і зробив логіку для цього для склейки блоків


Хоч і не перейшов на ffmpeg та все одно вирішив зробити все швидше завнтажувати відео зразу без аудіо зберігати з фпс яке можна редагувати 5 наприклад для таких як мій компьютер що не тяне просто


Також максимально зробив ловлю помилок ркім тих які не перешкоджають процесу але не мають бути
А також все безпечно навіть якщо помилка буде то цей врагмент запуститься знову


Логи зрозумілі з метриками


Валідація даних з pydentic


## What to add

Те що я не вспів доробити 

Перевести роботу з гугл діском в асинхрон


Додати логіку до jwt - > Оновлення токенів бд для зберігання юзерів і тд.


Обробка декількох запитів за раз -> Все підготував але не зробив -> Все в асинхронці крмі обробки зображень та гугл діском -Ю Тобто в черзі можна зразу буде запускати два запити


Змінити moviepy на ffmpeg -> наразі просто не залишилось часу щоб з цим розібратись


Додати clouflare для глибшої статистики + захист (це просто як ідея)


А також по гарному було б купити платну версія elevenlabs


## Tools that I have used

Як говорили - використовуєте FastApi у програмі тому вирішив те використати це плюс багато працював

moviepy - обробка зображень

redis - черга яка зберігається

jose - для jwt

google.oauth2 - для роботи з гугл діском



## Test
Посилання на гугл диск
```https://drive.google.com/drive/folders/1z_undwQoDpJRxjfwrDb1SwwMHACNBu7_?usp=sharing```

ПОсилання на тест апі - розмістив на ukraine.com.ua бізнес хостинг
```http://3384371.mf5f.web.hosting-test.net/docs```
Те що він буде працювати не можу обещать бо сервер дуже слабкий але подивитись може щось потестити можна
А ще він не підтримує докер
